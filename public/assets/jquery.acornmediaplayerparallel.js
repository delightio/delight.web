/*
 * Acorn Media Player - jQuery plugin 1.5
 *
 * Copyright (C) 2012 Ionut Cristian Colceriu
 *
 * Dual licensed under the MIT and GPL licenses:
 *   http://www.opensource.org/licenses/mit-license.php
 *   http://www.gnu.org/licenses/gpl.html
 *
 * www.ghinda.net
 * contact@ghinda.net
 *
 */
function parseSrt(e){var t=e.replace(/\r+/g,"");t=t.replace(/^\s+|\s+$/g,""),t=t.replace(/<[a-zA-Z\/][^>]*>/g,"");var n=[],r=t.split("\n\n");for(var i=0;i<r.length;i+=1){var s="",o,u,a,f;s=r[i],f=s.split(/\n/);if(!f[0].match(/^\d+$/)||!f[1].match(/\d+:\d+:\d+/))continue;var l=f[1].match(/(\d+):(\d+):(\d+)(?:,(\d+))?\s*--?>\s*(\d+):(\d+):(\d+)(?:,(\d+))?/);if(!l)continue;u=parseInt(l[1],10)*60*60+parseInt(l[2],10)*60+parseInt(l[3],10)+parseInt(l[4],10)/1e3,a=parseInt(l[5],10)*60*60+parseInt(l[6],10)*60+parseInt(l[7],10)+parseInt(l[8],10)/1e3,o=f.slice(2).join("<br>"),n.push({start:u,end:a,content:o})}return n}(function(e){e.fn.acornMediaPlayerParallel=function(t){function i(){try{return"localStorage"in window&&window.localStorage!==null}catch(e){return!1}}var n={theme:"access",nativeSliders:!1,volumeSlider:"horizontal",captionsOn:!1};t=e.extend(n,t);var r=function(){var e=new Date;return e.getTime()},s=i?localStorage.getItem("acornvolume"):1;s||(s=1);var o=function(){var n=e(this).find("video"),i={$self:e(this),$video1:e(n[0]),$video2:e(n[1])},o,u,a,f,l={play:"Play",playTitle:"Start the playback",pause:"Pause",pauseTitle:"Pause the playback",mute:"Mute",unmute:"Unmute",fullscreen:"Fullscreen",fullscreenTitle:"Toggle fullscreen mode",volumeTitle:"Volume control",seekTitle:"Video seek control",captions:"Captions",captionsTitle:"Show captions",captionsChoose:"Choose caption",transcript:"Transcript",transcriptTitle:"Show transcript",rotateLeft90:"-90",rotateLeft90Title:"Rotate -90",rotate0:"0",rotate0Title:"Original",rotate90:"90",rotate90Title:"Rotate 90",rotate180:"180",rotate180Title:"Rotate 180"},c=e('<div class="acorn-player" role="application"></div>').addClass(t.theme);i.$self.attr("tabindex","0"),i.id=i.$self.attr("id"),i.id||(i.id="acorn"+r(),i.$self.attr("id",i.id));var h='<div class="acorn-controls"><button class="acorn-play-button" title="'+l.playTitle+'" aria-controls="'+i.id+'">'+l.play+"</button>"+'<input type="range" class="acorn-seek-slider" title="'+l.seekTitle+'" value="0" min="0" max="150" step="0.1" aria-controls="'+i.id+'"/>'+'<span class="acorn-timer">00:00</span>'+'<span class="acorn-rotate-label">Rotate </span>'+'<button class="acorn-rotate-button" title="'+l.rotate180Title+'" id="rotate-180">'+l.rotate180+"</button>"+'<button class="acorn-rotate-button" title="'+l.rotate90Title+'" id="rotate-90">'+l.rotate90+"</button>"+'<button class="acorn-rotate-button" title="'+l.rotate0Title+'" id="rotate-0">'+l.rotate0+"</button>"+'<button class="acorn-rotate-button" title="'+l.rotateLeft90Title+'" id="rotate--90">'+l.rotateLeft90+"</button>"+"</div>",p='<div class="acorn-caption"></div>',d='<div class="acorn-transcript" role="region" aria-live="assertive"></div>';i.$self.wrap(c).after(h).after('<div class="loading-media"></div>'),i.$container=i.$self.parent(".acorn-player"),i.$controls=e(".acorn-controls",i.$container),i.$playBtn=e(".acorn-play-button",i.$container),i.$seek=e(".acorn-seek-slider",i.$container),i.$timer=e(".acorn-timer",i.$container),i.$volume=e(".acorn-volume-slider",i.$container),i.$volumeBtn=e(".acorn-volume-button",i.$container),i.$fullscreenBtn=e(".acorn-fullscreen-button",i.$container),i.$controls.after(p),i.$container.after(d),i.$transcript=i.$container.next(".acorn-transcript"),i.$transcriptBtn=e(".acorn-transcript-button",i.$container),i.$caption=e(".acorn-caption",i.$container),i.$captionBtn=e(".acorn-caption-button",i.$container),i.$captionSelector=e(".acorn-caption-selector",i.$container),i.$self.attr("data-width",i.$self.width()),i.$self.attr("data-height",i.$self.height());var v=function(e){var t=Math.floor(e/60)<10?"0"+Math.floor(e/60):Math.floor(e/60),n=Math.floor(e-t*60)<10?"0"+Math.floor(e-t*60):Math.floor(e-t*60);return t+":"+n},m=function(){i.$video1.prop("paused")?(i.$video1.trigger("play"),i.$video2.trigger("play")):(i.$video1.trigger("pause"),i.$video2.trigger("pause"))},g=function(){i.$playBtn.text(l.pause).attr("title",l.pauseTitle),i.$playBtn.addClass("acorn-paused-button")},y=function(){i.$playBtn.text(l.play).attr("title",l.playTitle),i.$playBtn.removeClass("acorn-paused-button")},b=function(){var e=i.$video1.prop("currentTime");i.$timer.text(v(e)),o||(t.nativeSliders?i.$seek.attr("value",e):i.$seek.slider("value",e)),f&&F()},w=function(e){var t=Math.floor(e/60)<10?""+Math.floor(e/60):Math.floor(e/60),n=Math.floor(e-t*60)<10?""+Math.floor(e-t*60):Math.floor(e-t*60),r,i="minutes",s="seconds";return t==1&&(min="minute"),n==1&&(e="second"),t===0?r=n+" "+s:r=t+" "+i+" "+n+" "+s,r},E=function(){i.$captionBtn.trigger("blur")},S=function(e,n){i.$video1.attr("paused")||(u=!0),i.$video1.trigger("pause"),i.$video2.trigger("pause"),o=!0;var r;t.nativeSliders?r=i.$seek.val():r=n.value,i.$video1[0].currentTime=r,i.$video2[0].currentTime=r,E()},x=function(t,n){u&&(i.$video1.trigger("play"),i.$video2.trigger("play"),u=!1),o=!1;var r=e(n.handle);r.attr("aria-valuenow",parseInt(n.value,10)),r.attr("aria-valuetext",w(n.value))},T=function(e,t){var n={role:"slider","aria-valuenow":parseInt(t.value,10),"aria-valuemin":parseInt(t.min,10),"aria-valuemax":parseInt(t.max,10),"aria-valuetext":t.valuetext,tabindex:"0"};e.attr(n)},N=function(){var t=i.$seek.attr("class"),n='<div class="'+t+'" title="'+l.seekTitle+'"></div>';i.$seek.after(n).remove(),i.$seek=e("."+t,i.$container);var r='<div class="ui-slider-range acorn-buffer"></div>';i.$seek.append(r),i.$buffer=e(".acorn-buffer",i.$container);var s={value:0,step:1,orientation:"horizontal",range:"min",min:0,max:100};i.$seek.slider(s)},C=function(){var n=i.$video1.get()[0].duration;if(t.nativeSliders)i.$seek.attr("max",n),i.$seek.bind("change",S),i.$seek.bind("mousedown",S),i.$seek.bind("mouseup",x);else{var r={value:0,step:1,orientation:"horizontal",range:"min",min:0,max:n,slide:S,stop:x};i.$seek.slider("option",r),r.valuetext=w(r.value),T(i.$seek.find(".ui-slider-handle"),r),e(".ui-slider-handle",i.$seek).click(E),i.$video1.bind("progress",k)}i.$self.next(".loading-media").remove(),m()},k=function(e){var t=parseInt(i.$video1.prop("duration"),10),n=this.buffered;if(n&&n.length){var r=parseInt(this.buffered.end(0)-this.buffered.start(0),10),s=r*100/t;i.$buffer.css("width",s+"%")}},L=function(e,t){s=t.value,localStorage.setItem("acornvolume",s),i.$video1.prop("muted")&&(i.$video1.prop("muted",!1),i.$video2.prop("muted",!1),i.$volumeBtn.removeClass("acorn-volume-mute"),i.$volumeBtn.text(l.mute).attr("title",l.mute)),i.$video1.prop("volume",s),i.$video2.prop("volume",s),i.$volume.$handle.attr("aria-valuenow",Math.round(s*100)),i.$volume.$handle.attr("aria-valuetext",Math.round(s*100)+" percent"),E()},A=function(){i.$video1.prop("muted")===!0?(i.$video1.prop("muted",!1),i.$video2.prop("muted",!1),t.nativeSliders?i.$volume.val(s):i.$volume.slider("value",s),i.$volumeBtn.removeClass("acorn-volume-mute"),i.$volumeBtn.text(l.mute).attr("title",l.mute)):(i.$video1.prop("muted",!0),i.$video2.prop("muted",!0),t.nativeSliders?i.$volume.val("0"):i.$volume.slider("value","0"),i.$volumeBtn.addClass("acorn-volume-mute"),i.$volumeBtn.text(l.unmute).attr("title",l.unmute))},O=function(){if(t.nativeSliders)i.$volume.bind("change",function(){i.$video1.prop("muted",!1),i.$video2.prop("muted",!1),s=i.$volume.val(),i.$video1.prop("volume",s),i.$video2.prop("volume",s)});else{var n=i.$volume.attr("class"),r='<div class="'+n+'" title="'+l.volumeTitle+'"></div>';i.$volume.after(r).remove(),i.$volume=e("."+n,i.$container);var o={value:s,orientation:t.volumeSlider,range:"min",max:1,min:0,step:.1,animate:!0,slide:L};i.$volume.slider(o),i.$volume.$handle=i.$volume.find(".ui-slider-handle"),o.max=100,o.value=o.value*100,o.valuetext=o.value+" percent",T(i.$volume.$handle,o),e(".ui-slider-handle",i.$volume).click(E)}i.$volumeBtn.click(A)},M=function(){i.$video1.attr({width:e(window).width(),height:e(window).height()})},_=function(){if(a){if(i.$video1[0].webkitSupportsFullscreen)i.$video1[0].webkitExitFullScreen();else{e("body").css("overflow","auto");var t=i.$video1.attr("data-width"),n=i.$video1.attr("data-height");i.$video1.removeClass("fullscreen-video").attr({width:t,height:n}),e(window).unbind("resize"),i.$controls.removeClass("fullscreen-controls")}a=!1}else i.$video1[0].webkitSupportsFullscreen?i.$video1[0].webkitEnterFullScreen():(e("body").css("overflow","hidden"),i.$video1.addClass("fullscreen-video").attr({width:e(window).width(),height:e(window).height()}),e(window).resize(M),i.$controls.addClass("fullscreen-controls")),a=!0},D="acorn-caption-active",P="acorn-caption-loading",H="acorn-transcript-active",B="acornCaptions"+r(),j=function(){captions="",i.$caption.hide(),activeCaptions=!1,i.$transcriptBtn.removeClass(H).hide(),i.$transcript.hide(),i.$captionBtn.removeClass(D)},F=function(){var e=i.$video1[0].currentTime,t="";for(var n=0;n<captions.length;n++)if(e>=captions[n].start&&e<=captions[n].end){t=captions[n].content;break}i.$caption.html(t)},I=function(){var t=function(){var e=i.$captionBtn.offset(),t=e.top-i.$captionSelector.outerHeight(!0),n=e.left-(i.$captionSelector.outerWidth(!0)-i.$captionBtn.outerWidth(!0))/2,r=i.$controls.offset();n-=r.left,t-=r.top,i.$captionSelector.css({top:t,left:n})};i.$fullscreenBtn.click(t),e(window).resize(function(){t()}),t();var n,r=function(){n&&clearTimeout(n),i.$captionSelector.show()},s=function(){n=setTimeout(function(){i.$captionSelector.hide()},200)};i.$captionBtn.click(function(){e(this).focus()}),i.$captionBtn.bind("focus",r),i.$captionBtn.bind("blur",s),e("input[name="+B+"]",i.$container).bind("focus",r),e("input[name="+B+"]",i.$container).bind("blur",s),i.$captionSelector.attr("tabindex","-1"),i.$captionSelector.bind("focus",r),i.$captionSelector.bind("blur",s)},q=function(t){i.$captionBtn.addClass(P),e.ajax({url:t,success:function(t){captions=parseSrt(t),i.$transcriptBtn.show();var n="";e(captions).each(function(){n+='<span data-begin="'+parseInt(this.start,10)+'" data-end='+parseInt(this.end,10)+">"+this.content.replace("'","")+"</span>"}),i.$transcript.html(n),i.$caption.show(),f=!0,i.$video1.prop("paused")&&F(),i.$captionBtn.addClass(D).removeClass(P)},error:function(){j(),console&&console.log("Error loading captions")}})},R=function(){e(this).hasClass(H)?i.$transcript.hide():i.$transcript.show(),e(this).toggleClass(H)},U=function(){i.$track=e("track",i.$video1),i.$track.length&&i.$captionBtn.show();if(i.$track.length>1){i.$captionBtn.attr("title",l.captionsChoose);var n='<ul><li><label><input type="radio" name="'+B+'" checked="true" />None</label></li>';i.$track.each(function(){var t=e(this).attr("src");n+='<li><label><input type="radio" name="'+B+'" data-url="'+e(this).attr("src")+'" />'+e(this).attr("label")+"</label></li>"}),n+="</ul>",i.$captionSelector.html(n);var r=function(){var t=e(this).attr("data-url");t?q(t):j()};e("input[name="+B+"]",i.$container).change(r),I();var s=i.$track.first().attr("src");t.captionsOn&&(q(s),e("input[name="+B+"]",i.$container).removeAttr("checked"),e("input[name="+B+"]:eq(1)",i.$container).attr("checked","true"))}else if(i.$track.length){var o=i.$track.attr("src");i.$captionBtn.bind("click",function(){e(this).hasClass(D)?j():q(o),e(this).toggleClass(D)}),t.captionsOn&&q(o)}i.$transcriptBtn.bind("click",R)},z=function(){i.$playBtn.click(m),i.$self.click(m),i.$self.bind("play",g),i.$self.bind("pause",y),i.$self.bind("ended",y),i.$video1.bind("timeupdate",b),i.$fullscreenBtn.click(_),O(),c.addClass(""),t.nativeSliders||N(),i.$video1.bind("loadedmetadata",function(){var e=window.setInterval(function(){i.$video1.get()[0].readyState>0&&i.$video2.get()[0].readyState>0&&(C(),clearInterval(e))},500);U()}),i.$video1.removeAttr("controls"),i.$video2.removeAttr("controls"),i.$video1.is("audio")&&i.$container.addClass("audio-player")}()};return this.each(o)}})(jQuery);